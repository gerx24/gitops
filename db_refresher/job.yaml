name: db refresh int [vulcan_core]


on:
  workflow_dispatch:
    inputs:
      database:
        description: "vulcan_int_x"
        required: true
        type: string
      environment:
        description: "environment"
        default: int
        type: string
      date:
        description: "Backup date format e.g 20250512 yyyymmdd"
        required: true
        type: string

  workflow_call:
    inputs:
      database:
        description: "vulcan_int_x"
        required: true
        type: string
      environment:
        description: "environment"
        default: int
        type: string
      date:
        description: "Backup date format e.g 20250512 year/month/day"
        required: true
        type: string

jobs:
  db-refresh-int:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: üîë Get AWS Creds
        id: aws-creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::183903597125:role/postgres-db-int-refresh

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --name ${{ inputs.environment }}-usva-pincer-project --region us-east-1

      - name: Deploy Job
        run: |
          export DB_NAME=${{ inputs.database }}
          export ENV=${{ inputs.environment }}
          export DATE=${{ inputs.date }}
          export PGPASSWORD=${{ secrets.PGPASSWORD }}

          cat <<EOF | envsubst | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: db-refresh-job-$DB_NAME
            namespace: vulcan-db-refresh
            labels:
              app: db-refresh-job
          spec:
            ttlSecondsAfterFinished: 300
            template:
              metadata:
                name: db-refresh-job
                labels:
                  app: db-refresh-job
              spec:
                initContainers:
                - name: copying-pgdump
                  image: amazon/aws-cli
                  command:
                    - /bin/sh
                    - -c
                    - |
                      echo "Copying files from elco-int-usva-vulcan-core-pg-backups"
                      aws s3 cp s3://elco-int-usva-vulcan-core-pg-backups/ /pg-dump --recursive
                  volumeMounts:
                    - name: pg-dump
                      mountPath: /pg-dump
                containers:
                - name: db-refresh
                  image: ghcr.io/elc-online/t-shoot/runner:1.0.0
                  env:
                    - name: PGPASSWORD
                      value: "$PGPASSWORD"
                    - name: DB_NAME
                      value: "$DB_NAME"
                    - name: ENV
                      value: "$ENV"
                    - name: DATE
                      value: "$DATE"
                  command: ["/bin/bash", "-c"]
                  args:
                    - |
                      echo "Dropping old database..."
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d postgres -c "ALTER DATABASE $DB_NAME OWNER TO root;"

                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d postgres -c " SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME AND pid <> pg_backend_pid(); DROP DATABASE $DB_NAME;"

                      echo "Creating new database..."
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d postgres -c "CREATE DATABASE $DB_NAME;"

                      echo "Changing ownership..."
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d postgres -c "ALTER DATABASE $DB_NAME OWNER TO vulcan_owner_green;"

                      echo "Restoring database..."
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d $DB_NAME -f /pg-dump/vulcan_dump_$DATE.sql

                      echo "Altering schema ownership..."
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d $DB_NAME -c "ALTER SCHEMA public OWNER TO vulcan_owner_role; ALTER SCHEMA client_side OWNER TO vulcan_owner_role; ALTER SCHEMA settings OWNER TO vulcan_owner_role;"

                      echo "Running script"
                      PGPASSWORD=$PGPASSWORD psql -h rds-global.vulcan.usva.$ENV.pincer-project.internal -p 5432 -U root -d $DB_NAME -f /pg-dump/privileges.sql
                  volumeMounts:
                    - name: pg-dump
                      mountPath: /pg-dump
                volumes:
                - name: pg-dump
                  emptyDir: {}
                imagePullSecrets:
                  - name: ghcr-credentials
                restartPolicy: OnFailure
                tolerations:
                  - effect: NoSchedule
                    key: karpenter-node
                    value: "true"
                serviceAccountName: vulcan-db-refresh
          EOF

      - name: Wait for Job to Succeed [5 minutes check]
        run: |
          echo "Checking status of job db-refresh-job-${{ inputs.database }}"
          for i in {1..30}; do
            STATUS=$(kubectl get job db-refresh-job-${{ inputs.database }} -n vulcan-db-refresh -o jsonpath="{.status.conditions[?(@.type=='Complete')].status}")
            if [[ "$STATUS" == "True" ]]; then
              echo "‚úÖ Job db-refresh-job-${{ inputs.database }} completed successfully."
              exit 0
            fi

            FAILED=$(kubectl get job db-refresh-job-${{ inputs.database }} -n vulcan-db-refresh -o jsonpath="{.status.failed}")
            if [[ "$FAILED" -ge 1 ]]; then
              echo "‚ùå Job db-refresh-job-${{ inputs.database }} failed."
              exit 1
            fi

            echo "‚è≥ Job db-refresh-job-${{ inputs.database }} not complete yet... waiting 10 seconds"
            sleep 10
          done

          echo "‚è∞ Timed out waiting for job to complete."
          exit 1


      - name: Delete Job
        run: |
          kubectl delete job db-refresh-job-${{ inputs.database }} -n vulcan-db-refresh
          echo "Job db-refresh-job-${{ inputs.database }} completed"